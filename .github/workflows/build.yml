name: Build SmartPOS Installers

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Show Java Version
      run: java -version
        
    - name: Build with Maven
      run: mvn clean package -DskipTests
      
    - name: Copy Dependencies
      run: |
        mkdir -p target/dist
        cp target/smartpos-*.jar.original target/dist/smartpos.jar
        mvn dependency:copy-dependencies -DoutputDirectory=target/dist
        
    - name: Build .deb Package
      run: |
        jpackage --type deb \
          --input target/dist/ \
          --main-jar smartpos.jar \
          --main-class com.smartpos.SmartPosLauncher \
          --name "smartpos" \
          --app-version "1.1.0" \
          --vendor "Antigravity" \
          --description "Smart Point of Sale System" \
          --icon "src/main/resources/icons/app_icon.png" \
          --linux-shortcut --linux-menu-group "Office" --verbose
          
    - name: Upload Linux Installer
      uses: actions/upload-artifact@v4
      with:
        name: smartpos-linux-deb
        path: "*.deb"

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Build with Maven
      run: mvn clean package -DskipTests
      
    - name: Copy Dependencies
      run: |
        New-Item -ItemType Directory -Force -Path target\dist
        Copy-Item target\smartpos-*.jar.original target\dist\smartpos.jar
        mvn dependency:copy-dependencies -DoutputDirectory=target\dist
      
    - name: Build .exe Installer
      run: |
        jpackage --type exe `
          --input target\dist\ `
          --main-jar smartpos.jar `
          --main-class com.smartpos.SmartPosLauncher `
          --name "SmartPOS" `
          --app-version "1.1.0" `
          --vendor "Antigravity" `
          --description "Smart Point of Sale System" `
          --icon "src\main\resources\icons\app_icon.png" `
          --win-shortcut --win-menu --verbose
          
    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: smartpos-windows-exe
        path: "*.exe"
